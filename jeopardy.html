<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Growe vaBanque</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
  /* T≈Ço i tekst */
  --color-bg: #000000;
  --color-text: #f3fbff;

  /* Kategorie */
  --color-category-top: #000183;
  --color-category-bottom: #000183;

  /* Kafelki (pytania) */
  --color-tile-top: #000183;
  --color-tile-bottom: #000183;
  --color-tile-taken-top: #0d47a1;
  --color-tile-taken-bottom: #1565c0;

  /* Przyciski */
  --color-btn-primary: #1e88e5;
  --color-btn-primary-hover: #1565c0;
  --color-btn-secondary: #555;
  --color-btn-warn: #d32f2f;

  /* Odpowiedzi i statusy */
  --color-answer: #063;
  --color-timeup: #d32f2f;
  --color-notice: #b00020;

  /* Timer */
  --color-timer-bg: rgba(0,0,0,0.08);
  --color-timer-fill-start: #ffd54a;
  --color-timer-fill-end: #ff9f1c;

  /* Karty / panele */
  --color-card-bg: rgba(255,255,255,0.05);
  --color-board-bg: rgba(255,255,255,0.03);
}

@font-face {
  font-family: 'ITC Korinna';
  src: url('fonts/ITCKorinna-Regular.woff2') format('woff2'),
       url('fonts/ITCKorinna-Regular.woff') format('woff');
  font-weight: normal;
  font-style: normal;
}

body {
  margin:0;
  font-family:'ITC Korinna', sans-serif;
  background: var(--color-bg);
  color: var(--color-text);
  overflow:hidden;
}

.container { display:flex; height:100vh; }

.card {
  flex-shrink:0;
  width:320px;
  overflow-y:auto;
  background: var(--color-card-bg);
  padding:16px;
  display:flex;
  flex-direction:column;
}

.players { display:flex; flex-direction:column; gap:10px; }

.player {
  display:flex; align-items:center; justify-content:space-between;
  padding:8px; border-radius:8px;
  background: var(--color-card-bg);
  box-shadow:0 0 8px rgba(0,0,0,0.3);
}

.score { font-size:22px; font-weight:900; min-width:50px; text-align:center; }

.boardWrap { flex-grow:1; overflow:auto; padding:10px; }

.board {
  display:grid; gap:10px; border-radius:10px; padding:10px;
  background: var(--color-board-bg); height:100%;
}

.board.disabled { pointer-events:none; opacity:0.7; }

.category {
  background:linear-gradient(180deg, var(--color-category-top), var(--color-category-bottom));
  padding:20px; text-align:center; font-weight:900;
  border-radius:8px; font-size:24px; color:white;
  text-shadow:1px 1px 3px black;
}

.tile {
  background:linear-gradient(180deg, var(--color-tile-top), var(--color-tile-bottom));
  padding:60px; text-align:center; font-size:48px; border-radius:10px;
  cursor:pointer; font-weight:900; color:orange;
  text-shadow:1px 1px 3px black; transition:all .2s;
}
.tile:hover {
  transform:translateY(-6px) scale(1.07);
  box-shadow:0 16px 40px rgba(0,0,0,0.5);
}
.tile.taken {
  background:linear-gradient(180deg, var(--color-tile-taken-top), var(--color-tile-taken-bottom));
  opacity:.7; cursor:default; text-decoration:line-through; transform:none;
}

#modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.85); z-index:999; }

.modalBox {
  background:white; color:#022; padding:24px; border-radius:12px;
  width:min(1250px,95%); height:min(80vh,700px);
  display:grid; grid-template-columns:2fr 1fr; gap:16px; overflow:hidden;
}

#meta { font-weight:900; font-size:26px; margin-bottom:12px; text-align:center }

#qtext { font-size:32px; line-height:1.3; text-align:center; word-break:break-word; }

#qimg { display:block; max-height:55vh; overflow:auto; padding:6px 0; }
#qimg img { max-width:100%; height:auto; display:block; margin:auto; border-radius:8px; }

#answerBox {
  display:none; margin-top:16px; font-weight:900; font-size:28px;
  color: var(--color-answer); text-align:center;
}

.timerBar {
  height:24px; background: var(--color-timer-bg);
  border-radius:999px; overflow:hidden; margin-top:12px; position:relative;
}
.timerFill {
  height:100%; background:linear-gradient(90deg, var(--color-timer-fill-start), var(--color-timer-fill-end));
  width:100%; transition:width 0.1s linear; transform-origin:left;
}
#timeLeft {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-weight:900; color:#032;
}

.btn {
  cursor:pointer; padding:10px 16px; border-radius:8px; border:none;
  background: var(--color-btn-primary); color:white; font-weight:700; font-size:18px;
  transition:all .15s;
}
.btn:hover { background: var(--color-btn-primary-hover); }
.btn.secondary { background: var(--color-btn-secondary); }
.btn.warn { background: var(--color-btn-warn); }
.btn:disabled { opacity:0.5; cursor:not-allowed; }

.notice {
  margin-top:10px; text-align:center; font-weight:900;
  color: var(--color-notice); display:none;
}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h2 style="text-align:center;margin-bottom:8px;">Gracze / Dru≈ºyny</h2>

    <div class="inlineAdd">
      <input id="newPlayerName" type="text" placeholder="Nazwa gracza/dru≈ºyny" class="pname" />
      <button id="addPlayerBtn" class="btn">Dodaj</button>
    </div>

    <div class="players" id="players"></div>
    <button id="resetPlayersBtn" class="btn secondary" style="margin-top:6px;width:100%">Reset</button>
    <button id="undoBtn" class="btn secondary" style="margin-top:6px;width:100%">Cofnij ostatniƒÖ akcjƒô (UNDO)</button>
    <button id="exportPlayersBtn" class="btn" style="margin-top:6px;width:100%">Zapisz uczestnik√≥w</button>

    <h3 style="margin-top:12px;">Pliki / arkusze</h3>
    <input type="file" id="fileIn" accept=".xlsx,.xls" />
    <select id="sheetSelect" style="margin-top:6px;width:100%"><option value="">Wybierz arkusz</option></select>

    <button id="saveGameFile" class="btn" style="margin-top:6px;width:100%;">Zapisz grƒô do pliku</button>
    <input type="file" id="loadGameFile" style="margin-top:6px;width:100%;" accept=".json" />

    <h3 style="margin-top:12px;">Timer pyta≈Ñ (sekundy)</h3>
    <input type="number" id="timerInput" value="10" min="1" max="60" style="width:100%;padding:6px;font-size:16px"/>

    <div class="notice" id="globalNotice"></div>

    <h3 style="margin-top:12px;">Fina≈Ç</h3>
    <button id="finalSidebarBtn" class="btn" style="width:100%">Uruchom fina≈Ç</button>
  </div>

  <div class="boardWrap card">
    <div id="board" class="board"></div>
  </div>
</div>

<div id="modal">
  <div class="modalBox">
    <div>
      <div id="meta"></div>
      <div id="qtext"></div>
      <div id="qimg" style="display:none"></div>
      <div id="answerBox"></div>
      <div class="timerBar">
        <div class="timerFill"></div>
        <div id="timeLeft"></div>
      </div>
    </div>
    <div style="background:#f6f9ff;padding:16px;border-radius:8px;display:flex;flex-direction:column;height:100%">
      <div id="playerBtns" class="playerBtns"></div>
      <div style="margin-top:auto;display:flex;gap:6px;justify-content:center;">
        <button id="showAnswerBtn" class="btn">Poka≈º</button>
        <button id="closeBtn" class="btn warn">Zamknij</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================
   Dane i stan aplikacji
   ============================ */
let data = [], finalData = [], used = new Set();
let playersState = [];
let activeTileEl = null, activeRow = null, isFinalFlow = false, finalPhase = '';
let timerInterval = null, countdownInterval = null, timerDuration = 10;

/* Historia akcji ‚Äî do UNDO */
let historyStack = [];
function pushHistory(action) {
  historyStack.push(action);
  if (historyStack.length > 200) historyStack.shift();
}
function undo() {
  const last = historyStack.pop();
  if (!last) { showNotice('Brak dzia≈Ça≈Ñ do cofniƒôcia', 1500); return; }

  if (last.type === 'score') {
    if (playersState[last.idx]) playersState[last.idx].score = last.prevScore;
  } else if (last.type === 'playerRemoved') {
    playersState.splice(last.idx, 0, last.player);
  } else if (last.type === 'finalWagerConfirm') {
    if (playersState[last.idx]) playersState[last.idx]._finalWager = last.prevWager;
  } else if (last.type === 'finalScoreAssign') {
    if (playersState[last.idx]) playersState[last.idx].score = last.prevScore;
  }
  saveGame();
  updateScores();
  renderPlayers();
}

/* ============================
   Elementy DOM
   ============================ */
const boardEl = document.getElementById('board');
const playersEl = document.getElementById('players');
const meta = document.getElementById('meta');
const qtext = document.getElementById('qtext');
const qimg = document.getElementById('qimg');
const answerBox = document.getElementById('answerBox');
const modal = document.getElementById('modal');
const playerBtns = document.getElementById('playerBtns');
const showAnswerBtn = document.getElementById('showAnswerBtn');
const closeBtn = document.getElementById('closeBtn');
const timerFill = document.querySelector('.timerFill');
const timeLeft = document.getElementById('timeLeft');
const timerInput = document.getElementById('timerInput');
const fileIn = document.getElementById('fileIn');
const sheetSelect = document.getElementById('sheetSelect');
const addPlayerBtn = document.getElementById('addPlayerBtn');
const newPlayerName = document.getElementById('newPlayerName');
const globalNotice = document.getElementById('globalNotice');
const exportPlayersBtn = document.getElementById('exportPlayersBtn');
const undoBtn = document.getElementById('undoBtn');
const saveGameFileBtn = document.getElementById('saveGameFile');
const loadGameFileInput = document.getElementById('loadGameFile');

/* ============================
   Persistence
   ============================ */
function saveGame() {
  try {
    localStorage.setItem('gameState', JSON.stringify({
      players: playersState,
      used: Array.from(used),
      timer: timerDuration
    }));
  } catch(e) { console.warn('saveGame fail', e); }
}
function loadGame() {
  try {
    const saved = localStorage.getItem('gameState');
    if (saved) {
      const state = JSON.parse(saved);
      playersState = Array.isArray(state.players) ? state.players : [];
      used = new Set(Array.isArray(state.used) ? state.used : []);
      if (typeof state.timer === 'number' && state.timer > 0) {
        timerDuration = state.timer;
        timerInput.value = timerDuration;
      }
    }
  } catch(e) { console.warn('loadGame fail', e); }
}
timerInput.addEventListener('change', e => {
  const val = parseInt(e.target.value);
  if (!isNaN(val) && val > 0) { timerDuration = val; saveGame(); }
});

/* ============================
   Timer
   ============================ */
function showTimeUp() {
  answerBox.style.display = 'block';
  answerBox.textContent = '‚è∞ Czas minƒÖ≈Ç!';
  answerBox.style.color = '#d32f2f';
  stopTimer();
  if (!isFinalFlow) {
    setTimeout(() => {
      answerBox.textContent = activeRow?.Answer || '';
      answerBox.style.color = '#063';
    }, 800);
  } else if (isFinalFlow && finalPhase === 'question') {
    setTimeout(renderFinalScoring, 600);
  }
}

function startTimer(sec = timerDuration) {
  stopTimer();
  timerFill.style.transition = 'none';
  timerFill.style.width = '100%';
  timerFill.offsetHeight; // reflow
  timerFill.style.transition = `width ${sec}s linear`;
  requestAnimationFrame(() => { timerFill.style.width = '0%'; });
  let remaining = sec;
  timeLeft.textContent = `${remaining}s`;
  countdownInterval = setInterval(() => {
    remaining -= 1;
    timeLeft.textContent = `${Math.max(remaining,0)}s`;
    if (remaining <= 0) { clearInterval(countdownInterval); }
  }, 1000);
  timerInterval = setTimeout(showTimeUp, sec * 1000);
}

function stopTimer() {
  if (timerInterval) { clearTimeout(timerInterval); timerInterval = null; }
  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
  timerFill.style.transition = 'none';
  timerFill.style.width = '100%';
  timeLeft.textContent = '';
}

/* ============================
   Gracze / UI
   ============================ */
function renderPlayers() {
  playersEl.innerHTML = '';
  playersState.forEach((p, idx) => {
    const el = document.createElement('div'); el.className = 'player';
    const addDisabled = !activeRow;
    el.innerHTML = `
      <div class="info">
        <input class="pname" data-idx="${idx}" value="${escapeHtml(p.name)}" />
      </div>
      <div class="controls">
        <div class="score" data-idx="${idx}">${p.score}</div>
        <button class="btn" data-act="add" data-idx="${idx}" ${addDisabled?'disabled':''} title="${addDisabled?'Aktywuj pytanie, aby dodaƒá punkty':''}">+</button>
        <button class="btn secondary" data-act="sub" data-idx="${idx}" ${addDisabled?'disabled':''} title="${addDisabled?'Aktywuj pytanie, aby odjƒÖƒá punkty':''}">-</button>
        <button class="btn warn" data-act="del" data-idx="${idx}">X</button>
      </div>`;
    playersEl.appendChild(el);
  });

  // Pod≈ÇƒÖcz zdarzenia
  document.querySelectorAll('.pname').forEach(i => {
    i.removeEventListener('input', onPlayerNameInput);
    i.addEventListener('input', onPlayerNameInput);
  });
  document.querySelectorAll('[data-act]').forEach(b => {
    b.removeEventListener('click', onPlayerAction);
    b.addEventListener('click', onPlayerAction);
  });
}

function onPlayerNameInput(e) {
  const idx = Number(e.target.dataset.idx);
  if (!Number.isNaN(idx) && playersState[idx]) {
    playersState[idx].name = e.target.value;
    saveGame();
    renderPlayers();
  }
}

function onPlayerAction(e) {
  const b = e.currentTarget;
  const idx = Number(b.dataset.idx);
  if (!Number.isNaN(idx) && playersState[idx]) {
    const act = b.dataset.act;
    if (act === 'add' && activeRow) {
      const val = getActiveValueForPlayer(idx);
      pushHistory({ type: 'score', idx, prevScore: playersState[idx].score });
      playersState[idx].score += val;
    } else if (act === 'sub' && activeRow) {
      const val = getActiveValueForPlayer(idx);
      pushHistory({ type: 'score', idx, prevScore: playersState[idx].score });
      playersState[idx].score -= val;
    } else if (act === 'del') {
      const removed = playersState[idx];
      if (!confirm(`UsunƒÖƒá gracza "${removed.name}"?`)) return;
      pushHistory({ type: 'playerRemoved', idx, player: {...removed} });
      playersState.splice(idx, 1);

      // je≈õli modal otwarty -> zamknij go i odbuduj planszƒô aby indeksy siƒô zgadza≈Çy
      if (modal.style.display === 'flex') {
        stopTimer();
        modal.style.display = 'none';
      }

      saveGame();
      updateScores();
      renderPlayers();
      buildBoard();
      return;
    }
    saveGame();
    updateScores();
    renderPlayers();
  }
}

function getActiveValueForPlayer(idx) {
  if (!activeRow) return 0;
  if (isFinalFlow && finalPhase === 'scoring') {
    return playersState[idx]._finalWager || 0;
  }
  if (activeRow.DailyDouble) {
    const rows = Array.from(playerBtns.querySelectorAll('.playerRow'));
    const input = rows[idx]?.querySelector('input[type="number"]');
    if (input) return Number(input.value) || 0;
  }
  return Number(activeRow.Value) || 0;
}

function updateScores() {
  playersState.forEach((p, idx) => {
    const el = document.querySelector(`.score[data-idx="${idx}"]`);
    if (el) el.textContent = p.score;
  });
}

/* ============================
   Dodawanie / reset
   ============================ */
addPlayerBtn.addEventListener('click', () => {
  const name = newPlayerName.value.trim();
  if (name) {
    playersState.push({ name, score: 0 });
    newPlayerName.value = '';
    saveGame();
    renderPlayers();
  }
});

document.getElementById('resetPlayersBtn').addEventListener('click', () => {
  const ok = confirm('Resetowaƒá punkty i planszƒô?');
  if (ok) {
    playersState.forEach(p => p.score = 0);
    used.clear();
    activeRow = null; activeTileEl = null;
    saveGame();
    buildBoard(); renderPlayers();
    showNotice('Zresetowano grƒô.');
  }
});

undoBtn.addEventListener('click', undo);

function showNotice(msg, timeout = 2000) {
  globalNotice.textContent = msg;
  globalNotice.style.display = 'block';
  setTimeout(() => { globalNotice.style.display = 'none'; }, timeout);
}

/* ============================
   Plansza
   ============================ */
function buildBoard() {
  boardEl.innerHTML = '';
  if (!data.length) { boardEl.innerHTML = '<div class="small">Wczytaj plik Excel</div>'; return; }
  const categories = [...new Set(data.map(r => r.Category))].slice(0, 6);
  const values = Array.from(new Set(data.map(r => r.Value))).sort((a,b)=>a-b).slice(0, 5);
  boardEl.style.gridTemplateColumns = `repeat(${categories.length},1fr)`;
  categories.forEach(cat => {
    const h = document.createElement('div'); h.className = 'category'; h.textContent = cat;
    boardEl.appendChild(h);
  });
  values.forEach(val => {
    categories.forEach(cat => {
      const row = data.find(r => r.Category === cat && r.Value === val);
      const tile = document.createElement('div'); tile.className = 'tile'; tile.textContent = row ? val : '';
      if (row) {
        const key = `${row.Category}__${row.Value}`;
        if (used.has(key)) tile.classList.add('taken');
        tile.addEventListener('click', () => {
          if (tile.classList.contains('taken')) return;
          activeTileEl = tile; activeRow = row;
          openModal(row, false);
        });
      } else { tile.style.opacity = 0.3; tile.style.pointerEvents = 'none'; }
      boardEl.appendChild(tile);
    });
  });
  renderPlayers();
}

/* ============================
   Modal / Pytania
   ============================ */
/* ============================
   RozwiƒÖzywanie ≈õcie≈ºek i wy≈õwietlanie obraz√≥w
   ============================ */

/**
 * resolveImageSrc(pathOrUrl)
 * - zamienia backslashy '\' na '/'
 * - akceptuje pe≈Çne URL (http/https)
 * - rozwiƒÖzuje ≈õcie≈ºki wzglƒôdne wzglƒôdem lokalizacji pliku HTML
 * Zwraca gotowy URL do przypisania do `img.src`
 */
function resolveImageSrc(pathOrUrl) {
  let raw = String(pathOrUrl || '').trim();
  raw = raw.replace(/\\/g, '/'); // zamiana backslashy

  if (!raw) return '';

  if (/^https?:\/\//i.test(raw)) return raw; // pe≈Çny URL

  try {
    return new URL(raw, window.location.href).href;
  } catch (e) {
    return raw;
  }
}

function showQuestionContent(row) {
  const qimg = document.getElementById('qimg');
  const qtext = document.getElementById('qtext');

  const typeRaw = (row.Type || row.type || '').toString().trim().toLowerCase();
  const questionRaw = (row.Question || row.question || '').toString().trim();

  let type = typeRaw;
  let question = questionRaw;

  if (!type && /\.(jpe?g|png|gif|webp|svg)$/i.test(question)) {
    type = 'image';
  }

  if (type === 'image' && question) {
    qtext.style.display = 'none';
    qimg.style.display = 'block';
    qimg.innerHTML = '';

    const img = document.createElement('img');
    img.alt = 'obraz';
    img.src = resolveImageSrc(question);

    img.style.maxHeight = '55vh';
    img.style.width = 'auto';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.style.objectFit = 'contain';
    img.style.borderRadius = '8px';

    img.addEventListener('error', () => {
      qimg.innerHTML = '<div style="text-align:center;padding:12px;color:#900;font-weight:700">Nie mo≈ºna wczytaƒá obrazka</div>';
      console.warn('B≈ÇƒÖd wczytywania obrazka:', img.src);
    });

    qimg.appendChild(img); // od razu dodaj obraz

  } else {
    qimg.style.display = 'none';
    qtext.style.display = 'block';
    qtext.textContent = question || '';
  }
}

/**
 * showQuestionContent(row)
 * - row: obiekt zawierajƒÖcy (co najmniej) Question i opcjonalnie Type
 * - automatycznie wykrywa typ obrazka na podstawie Type lub rozszerzenia pliku
 * - wstawia <img> do #qimg lub tekst do #qtext
 * - zabezpiecza przed zbyt du≈ºymi obrazami (kontener ma max-height i scroll)
 */
function showQuestionContent(row) {
  // normalizacja p√≥l (r√≥≈ºne nazwy kolumn w Excelu)
  const typeRaw = (row.Type || row.type || '').toString().trim().toLowerCase();
  const questionRaw = (row.Question || row.question || '').toString().trim();

  let type = typeRaw;
  let question = questionRaw;

  // autodetekcja: je≈õli Type pusty, sprawd≈∫ rozszerzenie pliku w question
  if (!type && /\.(jpe?g|png|gif|webp|svg)$/i.test(question)) {
    type = 'image';
  }

  if (type === 'image' && question) {
    // poka≈º obraz w #qimg
    qtext.style.display = 'none';
    qimg.style.display = 'block';
    qimg.innerHTML = ''; // wyczy≈õƒá zawarto≈õƒá kontenera

    const img = document.createElement('img');
    img.alt = 'obraz';
    img.src = resolveImageSrc(question);

    // estetyczne dopasowanie ‚Äî max wysoko≈õƒá, zachowanie proporcji
    img.style.maxHeight = '55vh';
    img.style.width = 'auto';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.style.objectFit = 'contain';
    img.style.borderRadius = '8px';

    // obs≈Çuga b≈Çƒôd√≥w wczytywania
    img.addEventListener('error', () => {
      qimg.innerHTML = '<div style="text-align:center;padding:12px;color:#900;font-weight:700">Nie mo≈ºna wczytaƒá obrazka</div>';
      console.warn('B≈ÇƒÖd wczytywania obrazka:', img.src);
    });

    // po za≈Çadowaniu dodaj obraz (obs≈Çuga cache)
    img.addEventListener('load', () => {
      if (!qimg.contains(img)) qimg.appendChild(img);
    });

    // fallback: append je≈õli ju≈º za≈Çadowany / cache
    setTimeout(() => {
      if (!qimg.contains(img) && img.complete) qimg.appendChild(img);
    }, 200);

  } else {
    // pokaz tekst w #qtext
    qimg.style.display = 'none';
    qtext.style.display = 'block';
    qtext.textContent = question || '';
  }
}

function openModal(row, isFinal = false) {
  activeRow = row;
  isFinalFlow = isFinal;
  finalPhase = isFinal ? 'wagers' : 'question';
  boardEl.classList.add('disabled');

  meta.textContent = `${row.Category || 'FINAL'} ‚Äî ${row.Value || ''}` + (row.DailyDouble ? ' üî• DAILY DOUBLE' : '');
  answerBox.style.display = 'none'; answerBox.textContent = ''; answerBox.style.color = '#063';
  qimg.style.display = 'none'; qimg.innerHTML = ''; qtext.style.display = 'block';
  playerBtns.innerHTML = '';

  if (String(row.Type || '').toLowerCase() === 'image' && !isFinal) {
    qtext.style.display = 'none';
    qimg.style.display = 'block';
    qimg.innerHTML = '';
    const img = document.createElement('img');
    img.alt = 'obraz';
    img.src = resolveImageSrc(row.Question || '');
    img.addEventListener('error', () => {
      qimg.innerHTML = '<div style="text-align:center;padding:12px;color:#900">Nie mo≈ºna wczytaƒá obrazka</div>';
    });
    img.addEventListener('load', () => { qimg.appendChild(img); });
    setTimeout(() => { if (!qimg.contains(img) && img.complete) qimg.appendChild(img); }, 400);
  } else {
    qtext.textContent = row.Question || (isFinal ? finalData[0]?.Question || '' : '');
  }

  if (isFinal) {
    renderFinalWagers();
    showAnswerBtn.style.display = 'none';
  } else {
    renderQuestionPlayerButtons(row);
    showAnswerBtn.style.display = 'inline-block';
    startTimer(timerDuration);
    const key = `${row.Category}__${row.Value}`;
    used.add(key);
    if (activeTileEl) activeTileEl.classList.add('taken');
    saveGame();
  }

  modal.style.display = 'flex';
  renderPlayers();
}

function renderQuestionPlayerButtons(row) {
  playerBtns.innerHTML = '';
  playersState.forEach((p, idx) => {
    const playerRow = document.createElement('div'); playerRow.className = 'playerRow';
    let val = Number(row.Value) || 0;

    if (row.DailyDouble) {
      const wagerInput = document.createElement('input');
      wagerInput.type = 'number';
      wagerInput.min = 0;
      wagerInput.max = Math.max(p.score, Number(row.Value) || 0);
      wagerInput.value = val;
      wagerInput.className = 'finalInput';
      wagerInput.style.marginRight = '6px';
      playerRow.appendChild(wagerInput);

      // dynamic label update (przyci≈õniƒôcia przy buttonach odwo≈ÇujƒÖ siƒô do aktualnego inputa)
      wagerInput.addEventListener('input', () => {
        const newVal = Number(wagerInput.value) || 0;
        btnOk.textContent = `‚úÖ ${p.name} (+${newVal})`;
        btnFail.textContent = `‚ùå ${p.name} (-${newVal})`;
      });
      val = Number(wagerInput.value) || 0;
    }

    const btnOk = document.createElement('button'); btnOk.className = 'btn';
    btnOk.textContent = `‚úÖ ${p.name} (+${val})`;
    btnOk.addEventListener('click', () => {
      const actualVal = row.DailyDouble ? (Number(playerRow.querySelector('input')?.value) || 0) : (Number(row.Value) || 0);
      pushHistory({ type: 'score', idx, prevScore: playersState[idx].score });
      playersState[idx].score += actualVal;
      updateScores();
      answerBox.style.display = 'block'; answerBox.textContent = row.Answer || '';
      answerBox.style.color = '#063';
      stopTimer();
      saveGame();
    });

    const btnFail = document.createElement('button'); btnFail.className = 'btn warn';
    btnFail.textContent = `‚ùå ${p.name} (-${val})`;
    btnFail.addEventListener('click', () => {
      const actualVal = row.DailyDouble ? (Number(playerRow.querySelector('input')?.value) || 0) : (Number(row.Value) || 0);
      pushHistory({ type: 'score', idx, prevScore: playersState[idx].score });
      playersState[idx].score -= actualVal;
      updateScores();
      saveGame();
    });

    playerRow.appendChild(btnOk);
    playerRow.appendChild(btnFail);
    playerBtns.appendChild(playerRow);
  });
}

function renderFinalWagers() {
  playerBtns.innerHTML = '';
  meta.textContent = `FINAL ‚Äî Wpisz stawki`;
  playersState.forEach((p, idx) => {
    p._finalWager = undefined;
    const div = document.createElement('div');
    div.className = 'playerRow';
    div.innerHTML = `
      <span style="font-weight:700">${escapeHtml(p.name)}:</span>
      <div style="display:flex;gap:6px;margin-left:auto;align-items:center;">
        <input type="number" min="0" max="${Math.max(0,p.score)}" value="${Math.max(0,Math.min(p.score || 0, p.score || 0))}" class="finalInput">
        <button class="btn">Zatwierd≈∫</button>
      </div>`;
    const input = div.querySelector('input');
    const btn = div.querySelector('button');
    btn.addEventListener('click', () => {
      const parsed = Math.max(0, Math.min(Number(input.value) || 0, p.score || 0));
      pushHistory({ type: 'finalWagerConfirm', idx, prevWager: p._finalWager });
      p._finalWager = parsed;
      input.disabled = true; btn.disabled = true;
      saveGame();
      if (playersState.every(pl => pl._finalWager !== undefined)) {
        renderFinalQuestion();
      }
    });
    playerBtns.appendChild(div);
  });
  showAnswerBtn.style.display = 'none';
}

function renderFinalQuestion() {
  finalPhase = 'question';
  meta.textContent = `FINAL ‚Äî Pytanie`;
  answerBox.style.display = 'none';
  playerBtns.innerHTML = '';
  qtext.style.display = 'block';
  qimg.style.display = 'none';

  const row = finalData[0] || activeRow || {};
  // obs≈Çuga obrazu w finale
  if (String(row.Type || '').toLowerCase() === 'image') {
    qtext.style.display = 'none';
    qimg.style.display = 'block';
    qimg.innerHTML = '';
    const img = document.createElement('img');
    img.alt = 'final image';
    img.src = resolveImageSrc(row.Question || '');
    img.addEventListener('error', () => {
      qimg.innerHTML = '<div style="text-align:center;padding:12px;color:#900">Nie mo≈ºna wczytaƒá obrazka</div>';
    });
    img.addEventListener('load', () => qimg.appendChild(img));
    setTimeout(() => { if (!qimg.contains(img) && img.complete) qimg.appendChild(img); }, 400);
  } else {
    qtext.textContent = row.Question || '';
  }

  startTimer(timerDuration);
  showAnswerBtn.style.display = 'inline-block';
}

function renderFinalScoring() {
  finalPhase = 'scoring';
  answerBox.style.display = 'block';
  answerBox.textContent = finalData[0]?.Answer || activeRow?.Answer || '';
  answerBox.style.color = '#063';
  playerBtns.innerHTML = '';
  meta.textContent = `FINAL ‚Äî Odpowiedzi i punktacja`;

  playersState.forEach((p, idx) => {
    const val = p._finalWager || 0;
    const row = document.createElement('div'); row.className = 'playerRow';
    const btnOk = document.createElement('button'); btnOk.className = 'btn';
    btnOk.textContent = `‚úÖ ${p.name} (+${val})`;
    const btnFail = document.createElement('button'); btnFail.className = 'btn warn';
    btnFail.textContent = `‚ùå ${p.name} (-${val})`;

    btnOk.addEventListener('click', () => {
      pushHistory({ type: 'finalScoreAssign', idx, prevScore: p.score });
      p.score += val;
      updateScores();
      btnOk.disabled = true; btnFail.disabled = true;
      saveGame();
    });
    btnFail.addEventListener('click', () => {
      pushHistory({ type: 'finalScoreAssign', idx, prevScore: p.score });
      p.score -= val;
      updateScores();
      btnOk.disabled = true; btnFail.disabled = true;
      saveGame();
    });

    row.appendChild(btnOk);
    row.appendChild(btnFail);
    playerBtns.appendChild(row);
  });

  boardEl.classList.remove('disabled');
  isFinalFlow = true;
  finalPhase = 'scoring';
}

/* ============================
   Zamkniƒôcie modal
   ============================ */
closeBtn.addEventListener('click', () => {
  modal.style.display = 'none';
  stopTimer();
  activeRow = null; activeTileEl = null;
  if (isFinalFlow) { isFinalFlow = false; finalPhase = ''; }
  boardEl.classList.remove('disabled');
  renderPlayers();
  saveGame();
});

showAnswerBtn.addEventListener('click', () => {
  if (isFinalFlow && finalPhase === 'question') {
    stopTimer();
    renderFinalScoring();
  } else {
    answerBox.style.display = 'block';
    answerBox.textContent = activeRow?.Answer || '';
    stopTimer();
  }
});

/* ============================
   Pliki / Excel
   ============================ */
function readWorkbook(file, cb) {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type:'array' });
    cb(wb);
  };
  reader.readAsArrayBuffer(file);
}

fileIn.addEventListener('change', e => {
  const f = e.target.files[0]; if (!f) return;
  readWorkbook(f, wb => {
    sheetSelect.innerHTML = '<option value="">Wybierz arkusz</option>';
    wb.SheetNames.forEach(n => { const opt = document.createElement('option'); opt.value=n; opt.textContent=n; sheetSelect.appendChild(opt); });
    sheetSelect.value = wb.SheetNames[0]; loadSheet(wb, sheetSelect.value);
  });
});

sheetSelect.addEventListener('change', e => {
  const f = fileIn.files[0]; if (!f) return;
  readWorkbook(f, wb => { loadSheet(wb, sheetSelect.value); });
});

function loadSheet(wb, sheetName) {
  const ws = wb.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
  if (sheetName.toLowerCase() === 'final') {
    finalData = json.map(r => ({
      Question: r.Question || r.Pytanie || r.question || '',
      Answer: r.Answer || r.Odpowiedz || r.answer || '',
      Type: r.Type || r.type || 'text'
    }));
  } else {
    data = json.map(r => ({
      Category: r.Category || r.category || r.Kategoria || 'Uncategorized',
      Value: Number(r.Value || r.value || 0),
      Question: r.Question || r.question || r.Pytanie || '',
      Answer: r.Answer || r.answer || r.Odpowiedz || '‚Äî',
      Type: (r.Type || r.type || 'text'),
      DailyDouble: String(r.DailyDouble || r.dailyDouble || r.Daily || '').toLowerCase().startsWith('t')
    }));
  }
  buildBoard();
}

/* ============================
   Export uczestnik√≥w
   ============================ */
function exportPlayersToExcel(){
  const ws = XLSX.utils.json_to_sheet(playersState.map(p=>({
    Name: p.name,
    Score: p.score
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Uczestnicy");
  XLSX.writeFile(wb, "uczestnicy.xlsx");
}
exportPlayersBtn.addEventListener('click', exportPlayersToExcel);

/* ============================
   Zapis / Wczytanie ca≈Çej gry (JSON)
   ============================ */
function downloadFile(name, text) {
  const blob = new Blob([text], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}
saveGameFileBtn.addEventListener('click', () => {
  const saveData = {
    players: playersState,
    used: Array.from(used),
    timer: timerDuration,
    data, finalData
  };
  downloadFile("jeopardy_save.json", JSON.stringify(saveData, null, 2));
});
loadGameFileInput.addEventListener('change', function () {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const loaded = JSON.parse(reader.result);
      playersState = loaded.players || [];
      used = new Set(loaded.used || []);
      timerDuration = loaded.timer || 10;
      data = loaded.data || data;
      finalData = loaded.finalData || finalData;
      timerInput.value = timerDuration;
      buildBoard();
      renderPlayers();
      saveGame();
      showNotice('Wczytano plik gry', 1500);
    } catch (err) {
      showNotice('B≈ÇƒÖd wczytywania pliku', 2000);
      console.error(err);
    }
  };
  reader.readAsText(file);
});

/* ============================
   Fina≈Ç - sidebar button
   ============================ */
document.getElementById('finalSidebarBtn').addEventListener('click', () => {
  if (!finalData.length) {
    showNotice('Brak pyta≈Ñ fina≈Çowych w arkuszu "final"!');
    return;
  }
  const row = { Category: 'FINAL', Value: '', Question: finalData[0].Question, Answer: finalData[0].Answer, Type: finalData[0].Type, DailyDouble: false };
  openModal(row, true);
});

/* ============================
   Util
   ============================ */
function escapeHtml(str = '') {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* ============================
   Init
   ============================ */
loadGame();
renderPlayers();
buildBoard();

</script>

</body>
</html>